<!DOCTYPE html>
<html lang="ja" style="background:#121212">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-512.png">
    <link rel="apple-touch-startup-image" href="/splash.png">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç™½é«ªãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <style>
        body { font-family: -apple-system, sans-serif; background: #121212; color: white; text-align: center; padding: 20px; }
        .container { max-width: 400px; margin: auto; background: #1e1e1e; padding: 25px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .result-area { font-size: 2.5rem; color: #4fd1c5; margin: 20px 0; font-weight: bold; }
        .btn { background: #4fd1c5; color: #121212; padding: 18px; border-radius: 15px; cursor: pointer; display: block; font-weight: bold; margin-bottom: 20px; text-decoration: none; }
        input[type="file"] { display: none; }
        .card { background: #2d2d2d; border-radius: 20px; padding: 15px; margin-top: 20px; }
        .chart-container { margin-top: 20px; height: 200px; }
        .loading { display: none; color: #4fd1c5; font-weight: bold; margin: 10px; }
        canvas { width: 100% !important; }
        .tips-toggle { background: #2d2d2d; border-radius: 15px; padding: 12px 16px; margin-top: 12px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; color: #aaa; font-size: 0.85rem; user-select: none; transition: border-radius 0.2s, background 0.2s; }
        .tips-toggle:hover { background: #363636; color: #fff; }
        .tips-toggle.open { border-radius: 15px 15px 0 0; }
        .tips-toggle .icon { transition: transform 0.2s; font-size: 0.8rem; }
        .tips-toggle.open .icon { transform: rotate(180deg); }
        .tips-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .tips-content.open { max-height: 500px; }
        .tips-inner { background: #252525; border-radius: 0 0 15px 15px; padding: 16px; margin-top: -8px; text-align: left; font-size: 0.8rem; line-height: 1.7; color: #bbb; }
        .tips-inner ul { margin: 0; padding-left: 20px; }
        .tips-inner li { margin-bottom: 6px; }
        .tips-inner strong { color: #4fd1c5; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin-top:0;">ç™½é«ªãƒˆãƒ©ãƒƒã‚«ãƒ¼</h2>
    
    <label class="btn">
        ğŸ“· ä»Šæ—¥ã®çŠ¶æ…‹ã‚’åˆ¤å®š
        <input type="file" accept="image/*" capture="camera" id="camera-input">
    </label>

    <div class="tips-toggle" id="tips-toggle" role="button" tabindex="0" aria-expanded="false">
        <span>ğŸ’¡ ã‚ˆã‚Šæ­£ç¢ºã«è§£æã™ã‚‹ãŸã‚ã®ã‚³ãƒ„</span>
        <span class="icon">â–¼</span>
    </div>
    <div class="tips-content" id="tips-content">
        <div class="tips-inner">
            <strong>ç…§æ˜ã®æ¡ä»¶</strong>
            <ul>
                <li><strong>æ˜ã‚‹ã•ï¼š</strong>è‡ªç„¶å…‰ã‚„å®¤å†…ç¯ã§ååˆ†ã«æ˜ã‚‹ã„å ´æ‰€ã§æ’®å½±</li>
                <li><strong>å‡ä¸€ãªå…‰ï¼š</strong>å½±ãŒã§ããªã„ã‚ˆã†ã€æ­£é¢ã‹ã‚‰å…‰ãŒå½“ãŸã‚‹ã‚ˆã†ã«</li>
                <li><strong>é€†å…‰ã‚’é¿ã‘ã‚‹ï¼š</strong>çª“ã‚„ãƒ©ã‚¤ãƒˆã‚’èƒŒã«ã—ãªã„</li>
                <li><strong>è›å…‰ç¯ã‚ˆã‚Šè‡ªç„¶å…‰ï¼š</strong>è‰²å‘³ãŒè‡ªç„¶ã«ãªã‚Šã€ç™½é«ªã®åˆ¤å®šãŒæ­£ç¢ºã«</li>
            </ul>
            <strong>æ’®å½±ã®ã‚³ãƒ„</strong>
            <ul>
                <li><strong>é«ªã‚’åºƒã’ã‚‹ï¼š</strong>åˆ†ã‘ç›®ã‚„å…¨ä½“ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«</li>
                <li><strong>è·é›¢ã‚’ä¸€å®šã«ï¼š</strong>æ¯å›åŒã˜è·é›¢ã§æ’®ã‚‹ã¨æ¨ç§»ãŒæ­£ç¢ºã«</li>
                <li><strong>èƒŒæ™¯ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼š</strong>é«ªä»¥å¤–ã®ç™½ã„éƒ¨åˆ†ãŒå†™ã‚Šè¾¼ã¾ãªã„ã‚ˆã†ã«</li>
            </ul>
        </div>
    </div>

    <div id="loading" class="loading">è§£æä¸­...</div>

    <div id="result-display" style="display:none;" class="card">
        <div style="font-size: 0.9rem; color: #aaa;">æœ€æ–°ã®ç™½é«ªç‡</div>
        <div class="result-area"><span id="ratio">0</span>%</div>
        <p id="advice" style="font-size: 0.9rem;"></p>
    </div>

    <div class="card">
        <div style="font-size: 0.9rem; color: #aaa; margin-bottom: 10px;">æ¨ç§»ã‚°ãƒ©ãƒ•</div>
        <div class="chart-container">
            <canvas id="historyChart"></canvas>
        </div>
        <button onclick="clearData()" style="background:none; border:none; color:#666; font-size:0.7rem; margin-top:10px;">å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script>
    const input = document.getElementById('camera-input');
    const loading = document.getElementById('loading');
    const resultDisplay = document.getElementById('result-display');
    let myChart;

    // èµ·å‹•æ™‚ã«ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºï¼ˆChart.jsèª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œï¼‰
    function init() {
        if (typeof Chart !== 'undefined') {
            updateChart();
        } else {
            setTimeout(init, 50);
        }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // ã‚³ãƒ„ã®é–‹é–‰
    const tipsToggle = document.getElementById('tips-toggle');
    const tipsContent = document.getElementById('tips-content');
    tipsToggle.addEventListener('click', () => {
        tipsToggle.classList.toggle('open');
        tipsContent.classList.toggle('open');
        tipsToggle.setAttribute('aria-expanded', tipsContent.classList.contains('open'));
    });
    tipsToggle.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            tipsToggle.click();
        }
    });

    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        loading.style.display = 'block';
        resultDisplay.style.display = 'none';

        const formData = new FormData();
        formData.append('image', file);

        try {
            const response = await fetch('/analyze', { method: 'POST', body: formData });
            const data = await response.json();
            
            document.getElementById('ratio').innerText = data.ratio;
            document.getElementById('advice').innerText = data.advice;
            resultDisplay.style.display = 'block';

            // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
            saveData(data.ratio);
        } catch (err) {
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        } finally {
            loading.style.display = 'none';
        }
    };

    // ã‚¹ãƒãƒ›ã®ä¿å­˜é ˜åŸŸï¼ˆLocalStorageï¼‰ã«è¨˜éŒ²ã™ã‚‹
    function saveData(ratio) {
        let history = JSON.parse(localStorage.getItem('hairHistory') || '[]');
        const now = new Date();
        const dateStr = (now.getMonth() + 1) + '/' + now.getDate();
        
        history.push({ date: dateStr, ratio: ratio });
        
        // ç›´è¿‘10å›åˆ†ã ã‘ä¿æŒ
        if (history.length > 10) history.shift();
        
        localStorage.setItem('hairHistory', JSON.stringify(history));
        updateChart();
    }

    // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ã™ã‚‹
    function updateChart() {
        const history = JSON.parse(localStorage.getItem('hairHistory') || '[]');
        const ctx = document.getElementById('historyChart').getContext('2d');
        
        const labels = history.map(h => h.date);
        const data = history.map(h => h.ratio);

        if (myChart) myChart.destroy(); // å¤ã„ã‚°ãƒ©ãƒ•ã‚’ç ´æ£„

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ç™½é«ªç‡ (%)',
                    data: data,
                    borderColor: '#4fd1c5',
                    backgroundColor: 'rgba(79, 209, 197, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#aaa' } },
                    x: { grid: { display: false }, ticks: { color: '#aaa' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function clearData() {
        if(confirm("å…¨ã¦ã®å±¥æ­´ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('hairHistory');
            updateChart();
            resultDisplay.style.display = 'none';
        }
    }
</script>

</body>
</html>