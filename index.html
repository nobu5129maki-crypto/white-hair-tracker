<!DOCTYPE html>
<html lang="ja" style="background:#121212">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-512.png">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç™½é«ªãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <style>
        body { font-family: -apple-system, sans-serif; background: #121212; color: white; text-align: center; padding: 20px; }
        .container { max-width: 400px; margin: auto; background: #1e1e1e; padding: 25px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .result-area { font-size: 2.5rem; color: #4fd1c5; margin: 20px 0; font-weight: bold; }
        .btn { background: #4fd1c5; color: #121212; padding: 18px; border-radius: 15px; cursor: pointer; display: block; font-weight: bold; margin-bottom: 20px; text-decoration: none; }
        input[type="file"] { display: none; }
        .card { background: #2d2d2d; border-radius: 20px; padding: 15px; margin-top: 20px; }
        .chart-container { margin-top: 20px; height: 200px; }
        .loading { display: none; color: #4fd1c5; font-weight: bold; margin: 10px; }
        canvas { width: 100% !important; }
        .tips-toggle { background: #2d2d2d; border-radius: 15px; padding: 12px 16px; margin-top: 12px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; color: #aaa; font-size: 0.85rem; user-select: none; }
        .tips-toggle:hover { background: #363636; color: #fff; }
        .tips-toggle.open { border-radius: 15px 15px 0 0; }
        .tips-toggle .icon { transition: transform 0.2s; font-size: 0.8rem; }
        .tips-toggle.open .icon { transform: rotate(180deg); }
        .tips-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .tips-content.open { max-height: 500px; }
        .tips-inner { background: #252525; border-radius: 0 0 15px 15px; padding: 16px; margin-top: -8px; text-align: left; font-size: 0.8rem; line-height: 1.7; color: #bbb; }
        .tips-inner ul { margin: 0; padding-left: 20px; }
        .tips-inner li { margin-bottom: 6px; }
        .tips-inner strong { color: #4fd1c5; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin-top:0;">ç™½é«ªãƒˆãƒ©ãƒƒã‚«ãƒ¼</h2>
    
    <label class="btn">
        ğŸ“· ä»Šæ—¥ã®çŠ¶æ…‹ã‚’åˆ¤å®š
        <input type="file" accept="image/*" capture="camera" id="camera-input">
    </label>

    <div class="tips-toggle" id="tips-toggle" role="button" tabindex="0" aria-expanded="false">
        <span>ğŸ’¡ ã‚ˆã‚Šæ­£ç¢ºã«è§£æã™ã‚‹ãŸã‚ã®ã‚³ãƒ„</span>
        <span class="icon">â–¼</span>
    </div>
    <div class="tips-content" id="tips-content">
        <div class="tips-inner">
            <strong>ç…§æ˜ã®æ¡ä»¶</strong>
            <ul>
                <li><strong>æ˜ã‚‹ã•ï¼š</strong>è‡ªç„¶å…‰ã‚„å®¤å†…ç¯ã§ååˆ†ã«æ˜ã‚‹ã„å ´æ‰€ã§æ’®å½±</li>
                <li><strong>å‡ä¸€ãªå…‰ï¼š</strong>å½±ãŒã§ããªã„ã‚ˆã†ã€æ­£é¢ã‹ã‚‰å…‰ãŒå½“ãŸã‚‹ã‚ˆã†ã«</li>
                <li><strong>é€†å…‰ã‚’é¿ã‘ã‚‹ï¼š</strong>çª“ã‚„ãƒ©ã‚¤ãƒˆã‚’èƒŒã«ã—ãªã„</li>
                <li><strong>è›å…‰ç¯ã‚ˆã‚Šè‡ªç„¶å…‰ï¼š</strong>è‰²å‘³ãŒè‡ªç„¶ã«ãªã‚Šã€ç™½é«ªã®åˆ¤å®šãŒæ­£ç¢ºã«</li>
            </ul>
            <strong>æ’®å½±ã®ã‚³ãƒ„</strong>
            <ul>
                <li><strong>é«ªã‚’åºƒã’ã‚‹ï¼š</strong>åˆ†ã‘ç›®ã‚„å…¨ä½“ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«</li>
                <li><strong>è·é›¢ã‚’ä¸€å®šã«ï¼š</strong>æ¯å›åŒã˜è·é›¢ã§æ’®ã‚‹ã¨æ¨ç§»ãŒæ­£ç¢ºã«</li>
                <li><strong>èƒŒæ™¯ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼š</strong>é«ªä»¥å¤–ã®ç™½ã„éƒ¨åˆ†ãŒå†™ã‚Šè¾¼ã¾ãªã„ã‚ˆã†ã«</li>
            </ul>
        </div>
    </div>

    <div id="loading" class="loading">è§£æä¸­...</div>

    <div id="result-display" style="display:none;" class="card">
        <div style="font-size: 0.9rem; color: #aaa;">æœ€æ–°ã®ç™½é«ªç‡</div>
        <div class="result-area"><span id="ratio">0</span>%</div>
        <p id="advice" style="font-size: 0.9rem;"></p>
    </div>

    <div class="card">
        <div style="font-size: 0.9rem; color: #aaa; margin-bottom: 10px;">æ¨ç§»ã‚°ãƒ©ãƒ•</div>
        <div class="chart-container">
            <canvas id="historyChart"></canvas>
        </div>
        <button onclick="clearData()" style="background:none; border:none; color:#666; font-size:0.7rem; margin-top:10px;">å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script>
    const input = document.getElementById('camera-input');
    const loading = document.getElementById('loading');
    const resultDisplay = document.getElementById('result-display');
    let myChart;

    function analyzeImage(file) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            const url = URL.createObjectURL(file);
            img.onload = () => {
                URL.revokeObjectURL(url);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxSize = 640;
                const scale = Math.min(maxSize / img.width, maxSize / img.height);
                canvas.width = Math.floor(img.width * scale);
                canvas.height = Math.floor(img.height * scale);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const data = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = data.data;
                let whiteCount = 0;
                const threshold = 200;
                for (let i = 0; i < pixels.length; i += 4) {
                    if (pixels[i] >= threshold && pixels[i+1] >= threshold && pixels[i+2] >= threshold) {
                        whiteCount++;
                    }
                }
                const total = canvas.width * canvas.height;
                const ratio = Math.round((whiteCount / total) * 1000) / 10;
                resolve(ratio);
            };
            img.onerror = () => {
                URL.revokeObjectURL(url);
                reject(new Error('ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚JPEGã¾ãŸã¯PNGå½¢å¼ã§æ’®å½±ã—ã¦ãã ã•ã„'));
            };
            img.src = url;
        });
    }

    function init() {
        if (typeof Chart !== 'undefined') updateChart();
        else setTimeout(init, 50);
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();

    document.getElementById('tips-toggle').addEventListener('click', () => {
        document.getElementById('tips-toggle').classList.toggle('open');
        document.getElementById('tips-content').classList.toggle('open');
    });
    document.getElementById('tips-toggle').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); document.getElementById('tips-toggle').click(); }
    });

    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        loading.style.display = 'block';
        resultDisplay.style.display = 'none';
        try {
            const ratio = await analyzeImage(file);
            document.getElementById('ratio').innerText = ratio;
            document.getElementById('advice').innerText = '';
            resultDisplay.style.display = 'block';
            saveData(ratio);
        } catch (err) {
            alert(err.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        } finally {
            loading.style.display = 'none';
        }
    };

    function saveData(ratio) {
        let history = JSON.parse(localStorage.getItem('hairHistory') || '[]');
        const now = new Date();
        history.push({ date: (now.getMonth() + 1) + '/' + now.getDate(), ratio: ratio });
        if (history.length > 10) history.shift();
        localStorage.setItem('hairHistory', JSON.stringify(history));
        updateChart();
    }

    function updateChart() {
        const history = JSON.parse(localStorage.getItem('hairHistory') || '[]');
        const ctx = document.getElementById('historyChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: history.map(h => h.date),
                datasets: [{
                    label: 'ç™½é«ªç‡ (%)',
                    data: history.map(h => h.ratio),
                    borderColor: '#4fd1c5',
                    backgroundColor: 'rgba(79, 209, 197, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#aaa' } },
                    x: { grid: { display: false }, ticks: { color: '#aaa' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function clearData() {
        if (confirm("å…¨ã¦ã®å±¥æ­´ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('hairHistory');
            updateChart();
            resultDisplay.style.display = 'none';
        }
    }
</script>

</body>
</html>
